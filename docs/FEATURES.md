# 派工系统功能说明

**版本**: 1.0
**更新日期**: 2025-10-20

---

## 核心功能

### 1. 数据同步

#### 1.1 自动同步机制

**页面加载同步**:
- 用户打开页面时,系统会立即触发一次数据同步
- 确保用户看到的是最新数据
- 显示"同步中..."提示,完成后显示"同步成功"

**定时自动同步**:
- 页面保持打开状态时,每隔1小时自动同步一次
- 默认开启,用户可通过页头复选框控制
- 实时显示下次同步倒计时(格式: "X小时Y分钟后")
- 用户偏好保存在浏览器本地存储,刷新页面后保持设置

**手动同步**:
- 用户可随时点击"同步数据"按钮手动触发同步
- 同步过程中按钮显示"同步中..."并禁用,防止重复点击
- 同步完成后显示成功或失败消息(3秒后自动消失)

#### 1.2 同步数据流程

```
飞书多维表格
    ↓ (通过飞书API)
后端服务
    ↓ (数据处理和存储)
SQLite数据库
    ↓ (通过REST API)
前端界面
```

**同步内容**:
- 客户公司名称
- 工作内容
- 售后工程师
- 优先级(非常紧急、紧急、重要)
- 申请状态
- 服务时间(开始时间、结束时间)

---

### 2. 数据展示

#### 2.1 周视图

**按日期视图**:
- 显示本周(周一到周五)的任务分配
- 每天显示为独立列
- 任务卡片按优先级着色:
  - 红色边框: 非常紧急
  - 橙色边框: 紧急
  - 蓝色边框: 重要

**按工程师视图**:
- 按工程师分组显示本周任务
- 每个工程师显示为独立行
- 横向显示周一到周五的任务分布
- 便于查看每个工程师的工作负载

#### 2.2 月视图

- 日历形式显示整月任务
- 支持查看不同月份
- 每个日期格子显示当天任务数量
- 点击日期可查看详细任务列表

#### 2.3 任务卡片

每个任务卡片显示:
- 📋 工作内容
- 🏢 客户公司名称
- 👨‍💼 售后工程师
- ⚡ 优先级标签
- 📅 服务时间
- 📊 申请状态

---

### 3. 时间导航

**周视图导航**:
- ⬅️ 上一周
- ➡️ 下一周
- 🏠 回到本周

**月视图导航**:
- ⬅️ 上个月
- ➡️ 下个月
- 🏠 回到本月

---

### 4. 统计面板

实时统计当前视图范围内的任务数量:
- 🔴 非常紧急: X 个
- 🟠 紧急: X 个
- 🔵 重要: X 个

统计数据随着时间范围和筛选条件动态更新。

---

### 5. 数据筛选

**筛选器配置** (`backend/filter_config.json`):
- 支持多种筛选条件组合
- 可按优先级、状态、工程师等字段筛选
- 支持的操作符:
  - `equals`: 完全匹配
  - `contains`: 包含
  - `in`: 在列表中
  - `not_empty`: 非空
  - 更多操作符详见 `docs/API_USAGE_GUIDE.md`

**默认筛选器**:
- 由 `active_filter` 配置决定
- 修改配置文件后需重启服务生效

---

### 6. 跨天任务处理

**智能展开**:
- 服务时间跨多天的任务会自动展开
- 每天显示一次该任务
- 方便查看每天的工作安排

**示例**:
```
飞书记录: 2025-10-20 09:00 ~ 2025-10-22 18:00
展开为:
- 2025-10-20: 该任务
- 2025-10-21: 该任务
- 2025-10-22: 该任务
```

---

## API功能

### 对外接口

系统提供RESTful API供其他系统集成使用:

**健康检查**:
```bash
GET /health
```

**获取任务列表**:
```bash
GET /api/tasks?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD&filter_name=default
```

**手动同步**:
```bash
POST /api/sync
Header: X-API-Key: your-api-key
```

**获取工程师列表**:
```bash
GET /api/engineers
```

详细API文档: `docs/API_USAGE_GUIDE.md`

---

## 认证与授权

### API密钥认证

系统使用API密钥进行认证:

**管理员密钥** (`API_KEYS`):
- 拥有读写权限
- 可以触发数据同步
- 可以修改数据

**只读密钥** (`READONLY_API_KEYS`):
- 只能读取数据
- 可以触发同步(POST /api/sync)
- 不能修改数据

### 请求限流

- 每个API密钥每分钟最多 `API_RATE_LIMIT` 次请求
- 超出限制返回 429 错误
- 默认限制: 100次/分钟

---

## 数据持久化

### 数据库设计

**两张主表**:

1. **feishu_records**: 存储飞书原始数据
   - 保留完整的飞书字段
   - 用于数据回溯和审计

2. **tasks**: 存储处理后的任务数据
   - 展平的任务记录
   - 跨天任务展开为多条记录
   - 用于快速查询和展示

**视图**:
- `current_week_tasks_view`: 自动计算本周任务
- 提高查询性能

### 数据备份

**自动备份** (可选):
```bash
# 使用提供的备份脚本
./backup.sh

# 或配置cron定时备份
0 2 * * * /path/to/Task_feishu/backup.sh
```

**备份内容**:
- 数据库文件: `data/db/tasks.db`
- 配置文件: `.env`, `filter_config.json`

---

## 浏览器兼容性

**支持的浏览器**:
- ✅ Chrome 90+
- ✅ Firefox 88+
- ✅ Safari 14+
- ✅ Edge 90+

**移动端支持**:
- ✅ iOS Safari 14+
- ✅ Android Chrome 90+
- 响应式设计,适配不同屏幕尺寸

---

## 性能特性

### 前端优化

- **React虚拟DOM**: 高效更新UI
- **Memoization**: 缓存计算结果,避免重复计算
- **代码分割**: 按需加载组件
- **静态资源缓存**: 提高加载速度

### 后端优化

- **数据库索引**: 加速查询
- **连接池**: 复用数据库连接
- **异步处理**: 非阻塞I/O
- **内存缓存**: 减少数据库访问

---

## 日志与监控

### 日志级别

可通过 `LOG_LEVEL` 环境变量配置:
- `DEBUG`: 详细调试信息
- `INFO`: 一般信息(默认)
- `WARNING`: 警告信息
- `ERROR`: 错误信息

### 日志查看

**Docker部署**:
```bash
# 查看所有日志
docker-compose logs -f

# 仅查看后端日志
docker-compose logs -f app

# 仅查看前端日志
docker-compose logs -f frontend
```

**手动部署**:
- 后端日志: 控制台输出
- 前端日志: 浏览器控制台

---

## 安全特性

### 跨域控制

- `ALLOWED_ORIGINS` 配置允许访问的域名
- 防止未授权的跨域访问
- 部署时需根据实际域名配置

### API认证

- 所有API端点需要API密钥认证
- 密钥通过 `X-API-Key` 请求头传递
- 支持多个密钥,便于密钥轮换

### 请求限流

- 防止API滥用
- 保护服务器资源
- 可配置限流阈值

---

## 未来计划

- [ ] 任务编辑功能
- [ ] 任务状态更新
- [ ] 邮件通知
- [ ] 移动端APP
- [ ] 数据导出(Excel/PDF)
- [ ] 高级筛选器
- [ ] 任务评论和协作
- [ ] 工作量统计报表

---

## 技术栈

### 后端
- **框架**: FastAPI (Python)
- **数据库**: SQLite (支持MySQL)
- **异步**: uvicorn + asyncio
- **API文档**: OpenAPI 3.0 (Swagger UI)

### 前端
- **框架**: React 18
- **构建工具**: Create React App
- **样式**: Tailwind CSS
- **图标**: Font Awesome

### 部署
- **容器化**: Docker + Docker Compose
- **Web服务器**: Nginx (前端)
- **反向代理**: 可选(生产环境推荐)

---

**相关文档**:
- 部署指南: `docs/DEPLOYMENT_GUIDE.md`
- API文档: `docs/API_USAGE_GUIDE.md`
- 快速部署: `README_DEPLOY.md`
